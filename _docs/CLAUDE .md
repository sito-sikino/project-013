# CLAUDE.md - Discord Multi-Agent System

このファイルは、[Claude Code](https://www.anthropic.com/claude-code) がこのリポジトリのコードを扱う際のガイダンスを提供します。

## ドキュメント構成

- `spec.md` - 要件定義
- `architecture.md` - アーキテクチャ詳細

## プロジェクト概要

Redis に当日全文脈を一元保存し、Gemini 2.0 Flash を用いて「ユーザー応答（即時）／自発発言（tick×確率）／06:00日報（500字）」を行うDiscordマルチエージェント（受信はSpectraのみ、送信は選定Bot名義）。


## 🚨 **最重要事項**

Claude Code は次の原則を**絶対基準**として実装に従う。コード・設定・命名・タスク処理すべてが、この基準を背骨として段階的に進む。

### 設定管理原則
- **一元管理**：設定値は意味ごとに構造化し `settings.py` で一元管理  
- **環境対応**：環境依存値や機密情報はすべて `.env` に置き、`settings.py` で動的読み込み  
- **意味的実装**：コードは具体値ではなく意味名（例 `SPEECH_INTERVAL`）で制御  
- **ハードコード禁止**：具体値はすべて `.env` と `settings.py` 経由で注入することで動的に制御する
- **venv必須**：Python仮想環境は必ず `venv` を使用し、依存関係を分離管理する

### 開発原則
- **Fail-Fast**：すべてのエラーは即時に停止し、原因を表面化させる（Fail-Fast）。**すべての処理は例外時にもフォールバックせず、明示的に失敗させる設計**とする。  
- **最小実装**：要求機能だけを実装し、余分なコードやファイルを加えない  
- **TDD採用**：t-wada式 Red→Green→Refactor→Commit を徹底  

### コード品質
- **本質性**：不要ファイル・冗長コードを排除  
- **日本語コメント**：本質的な意図のみを簡潔に日本語で記述  
- **命名**：Uncle Bob の Intention-Revealing Names に従う  

---

## Phase 1 EXPLORE（調査）

**目的**  
- 文脈と依存関係を把握し、実装前に全体像を理解する

**行動**  
1. Brave Search、公式ドキュメント、GitHub を一次情報源として調査  
2. `.env`, `Dockerfile`, CI 設定、依存ライブラリ、`settings.py` を確認  
3. Context7（mcp） に調査内容を蓄積・整理し、Claude（Use Subagent）で役割分担  
4. Serena (mcp) を駆使し、文脈を正確に保持し続ける
5. 過去ログ `_docs/dev-log/`（`yyyy-mm-dd_hh-mm_機能名.md`）を全読み込みし、既存の設計意図・副作用を把握

---

## Phase 2 PLAN（計画）

**目的**  
- 実装を最小タスクへ分割し、受け入れ条件と運用ルールを明確にする

**行動**  
1. `todo.md` にマイクロタスクを列挙し、各タスクに受け入れ条件を付与  
2. 各タスクを t-wada式 TDD サイクル 1回分として設計  
3. `settings.py` に置く定数と `.env` の環境値を棚卸し  
4. Context7 + Claude（Use Subagent） でタスク粒度・設計整合性をレビュー
5. Serena (mcp) を駆使し、文脈を正確に保持し続ける

---

## Phase 3 IMPLEMENT（実装）

**ルール**
- **ハードコード禁止**：具体値はすべて `.env` と `settings.py` 経由で注入することで動的に制御する
- **Fail-Fast** を最上位原則とし、異常時は即停止  
- **フォールバック禁止**：いかなる例外も認めず、本来の目的コード以外の例外措置は施さない
- **Serena (mcp)** を駆使し、文脈を正確に保持し続ける

### 🔴 Red — 失敗するテストを書く  
- 未実装状態で必ず失敗するユニットテストを 1 件追加し、仕様を固定

### 🟢 Green — 最小実装でテストを通す  
- 余計なロジックを加えず最小コードでテストを通過  
- 必要な箇所には簡潔な日本語コメントで本質的な意図のみを記述

### 🟡 Refactor — 品質と構造の改善  
- DRY、命名整理、単純化、`black`・`flake8`・`mypy` 準拠  
- テストは常に Green を維持

### ⚪ Commit — 意味単位で保存

1. **todo.md を更新**  
   - 完了タスクを ✅ にチェック  
   - タスク全文（箇条書き内容を含む）を `_docs/dev-log/` に移動して履歴化

2. **実装ログを作成**  
   - `_docs/dev-log/yyyy-mm-dd_hh-mm_機能名.md` を新規作成（※現在時刻を確認）  
   - 以下を簡潔に記載  
     - 完了タスク全文  
     - 実装の背景  
     - 設計意図  
     - 副作用 / 注意点  
     - 関連ファイル・関数

3. **Git 操作**  
   - `git add .` でコード・todo.md・ログをステージング  
   - `pytest` で最終テスト確認  
   - 意図が伝わるコミットメッセージで `git commit`  
   - 変更をリモートへ `git push`

> こうすることで **コード・タスク管理・実装ログ** が同一コミットに揃い、  
> 履歴と進捗が完全に同期される。

---

## Phase 4 VERIFY（統合検証・記録・コミット）

**目的**  
- 要件・品質基準への最終適合と成果物固定

**行動**  
1. すべてのタスクについて統合テスト (`pytest` 全体) を実行  
2. 全コードに `black --check`, `flake8`, `mypy` を適用し合格を確認  
3. 合格したタスクを `todo.md` で ✅ に更新し、該当タスク全文を  
   `_docs/dev-log/yyyy-mm-dd_hh-mm_機能名.md` に移動して以下を記録：  
   - タスク全文  
   - 実装の背景  
   - 設計意図  
   - 副作用 / 注意点  
   - 関連ファイル・関数  
4. 変更一式（コード・todo.md・ログ）を `git add .` でステージングし、  
   意図が伝わるコミットメッセージで `git commit && git push`  
5. **意味ある単位として完結**し、次フェーズへ進める状態になっている

---
