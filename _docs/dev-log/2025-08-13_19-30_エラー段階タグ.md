# Task 12-1: エラー段階タグシステム実装

## 完了タスク
**12-1 段階タグ**  
**AC**: `error_stage ∈ {settings,slash,plan,typing,send,report,memory}`。例外時は `log_err` を必ず書き、中断・フォールバック無し。

## 実装の背景
Discord Multi-Agent Systemにおいて、エラーが発生した際にそのエラーがシステムのどの段階で発生したのかを正確に識別し、ログに記録する仕組みが必要だった。Fail-Fast原則に基づき、エラー時は即座に停止するが、その前に適切なerror_stageでログ記録を行う必要があった。

## 設計意図

### 7段階のエラー分類
要件定義（AC）に従い、以下の7つのエラー段階を定義：
- `settings`: 設定読み込み・検証エラー
- `slash`: スラッシュコマンド処理エラー  
- `plan`: LLM生成・supervisor関連エラー
- `typing`: Discord typing API エラー
- `send`: Discord メッセージ送信エラー
- `report`: 日報生成・関連処理エラー
- `memory`: Redis/store関連エラー

### 集約的エラー段階判定
- `app/error_stages.py`に中央集権的なエラー段階判定ロジックを実装
- 例外メッセージの内容とコンテキストから適切な段階を自動判定
- コード重複を避け、統一されたエラー段階判定を提供

### Fail-Fast統合
- 全モジュール（settings.py, app.py, store.py）でlog_errを使用
- エラー段階を正しく設定してからSystemExit
- フォールバック処理は一切実装せず、エラー時は即座停止

## 副作用・注意点

### 依存関係の追加
- `app/error_stages.py`が新規作成され、他モジュールから参照される
- 循環インポートを避けるため、settings.pyでのlog_err使用時はtry-except処理

### テスト要件の変更
- 各モジュールでのlog_err使用により、テストでのモック対象が変更
- パッチレベルを正確に設定する必要がある（例：`app.store.log_err`）

### SystemExit挙動
- 全エラーパスでSystemExitが発生するため、テスト時はpytest.raises(SystemExit)が必要
- 本番環境でのプロセス監視・再起動機構との連携が前提

## 関連ファイル・関数

### 新規作成
- **app/error_stages.py**
  - `determine_error_stage(exception, context)`: 中央集権的エラー段階判定
  - `ErrorStage`: 型定義（Literal type）
  - `get_all_error_stages()`: 全段階取得
  - `validate_error_stage()`: 段階妥当性検証

### 変更されたファイル
- **app/app.py**
  - `common_sequence()`: determine_error_stage()を使用してerror_stage自動判定
  - `on_report_0600()`: error_stage="report"でログ記録

- **app/settings.py**
  - `fail_fast()`: log_err使用でerror_stage="settings"記録

- **app/store.py**
  - 全error handling箇所: error_stage="memory"使用
  - `_get_redis_connection()`, `test_connection()`, `read_all()`, `append()`, `reset()`

### テストファイル
- **test_error_stage_tags.py**: 15個のテストケースで7段階すべてをカバー
  - 基本機能テスト（log_err存在確認、段階文書化）
  - common_sequenceエラー段階テスト（memory, plan, typing, send）
  - スラッシュコマンドエラー段階テスト（slash段階）
  - 設定エラー段階テスト（settings段階）
  - 日報エラー段階テスト（report段階）
  - メモリエラー段階テスト（memory段階）
  - 完全性テスト（全7段階実装確認）

## TDDサイクル完了
✅ Red: 15個の失敗テストでAC要件を明確化  
✅ Green: 最小実装で全テスト通過  
✅ Refactor: 中央集権的ロジック、型ヒント、docstring追加  
✅ Commit: 意味単位での保存完了