# 2025-08-13_16-47 日報生成・リセットシステム実装

## 完了タスク
- [x] 11-2 生成/リセット  
**AC**: **Spectra固定・500字以内**・**LLM1回**・投稿先=command-center。送信成功後に `store.reset()`、`mode=ACTIVE`、`active_channel=command-center`。

## 実装の背景
Discord Multi-Agent Systemにおける日報生成・投稿・システムリセット機能の実装。
毎日JST 06:00に実行される日報処理の本体部分で、Task 11-1のトリガーシステムから呼び出されます。

## 設計意図

### AC要件完全対応
✅ **Spectra固定・500字以内・LLM1回**
- common_sequence経由でSpectra固定投稿（Bot選択なし）
- llm_kind="report"でレポート専用LLM実行
- supervisor.pyの500字制限機能活用

✅ **投稿先=command-center**
- channel="command-center"、llm_channel=settings.discord.chan_command_center指定
- Discord IDは設定から動的取得

✅ **送信成功後にstore.reset()・mode=ACTIVE・active_channel=command-center**
- common_sequence成功後の確実な実行順序保証
- Fail-Fast原則による段階的エラー処理

## TDDサイクル実施

### 1. Red段階: 失敗テスト作成（13項目）
包括テストスイート `test_daily_report_generation.py` 実装:

#### TestDailyReportGenerationBasic（3項目）
- on_report_0600関数存在・非同期関数・スタブからの脱却確認

#### TestDailyReportSpectraFixedPosting（3項目）
- Spectra固定投稿・command-center投稿・イベント種別/アクター確認

#### TestDailyReportResetSequence（3項目）
- store.reset()呼び出し・active_channel設定・mode=ACTIVE設定

#### TestDailyReportContent（1項目）
- 日報ペイロード要約内容確認

#### TestDailyReportExecutionOrder（1項目）
- common_sequence→store.reset→state更新の実行順序保証

#### TestDailyReportErrorHandling（1項目）
- common_sequence失敗時のFail-Fast動作確認

#### TestDailyReportIntegration（1項目）
- 全機能統合テスト

### 2. Green段階: 最小実装
`on_report_0600` 関数完全刷新:

```python
async def on_report_0600() -> None:
    """日報処理ハンドラ（11-2：06:00特別タイミング）"""
    from app import store, state, settings
    
    # Stage 1: 日報生成・投稿（common_sequenceでSpectra固定・command-center）
    await common_sequence(
        event_type="report",
        channel="command-center",
        actor="spectra",
        payload_summary="daily_report_0600",
        llm_kind="report",
        llm_channel=settings.settings.discord.chan_command_center
    )
    
    # Stage 2: 全文脈リセット（日報送信成功後のみ実行）
    store.reset()
    
    # Stage 3: 状態更新（mode=ACTIVE・active_channel=command-center）
    from app.state import Mode
    state.update_mode(Mode.ACTIVE)
    state.set_active_channel("command-center")
```

**主要機能**:
- **Spectra固定投稿**: actor="spectra"でBot選択を排除
- **command-center投稿**: チャンネル指定とDiscord ID設定連携
- **LLM1回実行**: llm_kind="report"で500字制限適用
- **段階的処理**: common_sequence→store.reset→state更新の順序保証
- **Fail-Fast原則**: 各段階でのエラー時即座停止

### 3. Refactor段階: 品質改善
- **詳細docstring**: 機能説明・処理順序・エラー情報・統合情報
- **Fail-Fast文書化**: 各段階でのエラーハンドリング動作明記
- **段階別コメント**: Stage 1〜3の明確な区分と役割説明

## 主要実装内容

### on_report_0600ハンドラ

#### Stage 1: 日報生成・投稿
```python
await common_sequence(
    event_type="report",
    channel="command-center",
    actor="spectra",
    payload_summary="daily_report_0600",
    llm_kind="report",
    llm_channel=settings.settings.discord.chan_command_center
)
```

**特徴**:
- **Spectra固定**: actor="spectra"でBot選択ロジック回避
- **レポート専用**: llm_kind="report"で500字制限・日報フォーマット適用
- **設定連携**: Discord IDを設定から動的取得
- **ペイロード識別**: "daily_report_0600"で日報処理として明確化

#### Stage 2: 全文脈リセット
```python
store.reset()
```

**効果**:
- **日報後クリア**: Redis全文脈を完全削除
- **新日開始**: 前日の会話履歴を持ち越さない
- **Fail-Fast**: 日報送信成功後のみ実行（前段階失敗時は実行しない）

#### Stage 3: 状態更新
```python
from app.state import Mode
state.update_mode(Mode.ACTIVE)
state.set_active_channel("command-center")
```

**設計**:
- **ACTIVEモード**: 日中の通常運用モードに移行
- **command-center**: 日報投稿先と同じチャンネルをアクティブに設定
- **即座切替**: 日報直後から通常運用開始

## エラーハンドリング（Fail-Fast原則）

### Stage別エラー対応
```python
# Stage 1: common_sequence失敗
# → 例外伝播で即座停止、後続のresetは実行しない

# Stage 2: store.reset失敗  
# → SystemExitで即座プロセス終了

# Stage 3: state操作失敗
# → 例外伝播で即座停止
```

**原則**:
- **即座停止**: エラー時はFail-Fast原則で例外伝播・プロセス終了
- **段階保護**: 前段階失敗時は後段階を実行しない
- **明確エラー**: エラー原因を隠蔽せず明確化

## common_sequence統合

### 既存システム活用
- **Redis全文読み**: 前日までの全文脈を日報生成に活用
- **LLM生成**: supervisor.py経由でGemini 2.0 Flash実行
- **Discord送信**: discord.py経由でSpectra名義投稿
- **ログ記録**: logger.py経由で成功・失敗ログ出力

### レポート専用設定
```python
# common_sequence内でllm_kind="report"時の処理
result = await supervisor.generate(
    kind="report",  # レポート専用処理
    channel=llm_channel,
    task=task_content,
    context=context,
    limits=limits,
    persona=persona,
    report_config={"format": "daily", "max_chars": 500}  # 500字制限
)
```

## テストカバレッジ（13項目）

### 基本機能（3項目）
- 関数存在・非同期対応・スタブ脱却

### Spectra固定投稿（3項目）
- Bot固定・投稿先・イベント種別確認

### リセット処理（3項目）
- store.reset・active_channel・mode設定

### コンテンツ・順序・エラー処理（3項目）
- ペイロード内容・実行順序・Fail-Fast動作

### 統合テスト（1項目）
- 全機能結合確認

## 副作用 / 注意点

### システム状態変更
- **Redis全削除**: 前日までの全会話履歴が消失
- **モード切替**: STANDBY/PROCESSING → ACTIVE への即座切替
- **チャンネル切替**: active_channel → command-center 固定

### 実行タイミング
- **06:00丁度**: Task 11-1のDailyReportSchedulerから呼び出し
- **1日1回**: バックフィル無しで確実に1回のみ実行
- **成功前提**: common_sequence成功を前提としたリセット処理

### Task 11-1との連携
- **トリガー**: DailyReportScheduler._execute_daily_report()から呼び出し
- **エラー伝播**: on_report_0600のエラーはScheduler側に伝播
- **実行記録**: Scheduler側で実行完了マーキング

## 関連ファイル・関数
- `/home/u/dev/project-013/app/app.py`
  - `on_report_0600()`: 日報処理メインハンドラ（本実装）
  - `common_sequence()`: 統合された投稿処理システム
  - `DailyReportScheduler._execute_daily_report()`: 呼び出し元（Task 11-1）
- `/home/u/dev/project-013/test_daily_report_generation.py`
  - 全13テストケース（基本・投稿・リセット・順序・エラー・統合）
- `/home/u/dev/project-013/app/store.py`
  - `reset()`: Redis全文脈リセット機能
- `/home/u/dev/project-013/app/state.py`
  - `update_mode()`: システムモード更新
  - `set_active_channel()`: アクティブチャンネル設定
- `/home/u/dev/project-013/app/supervisor.py`
  - `generate(kind="report")`: 日報専用LLM生成（500字制限）

## パフォーマンス特性
- **LLM1回実行**: supervisor.generate()での単発実行
- **Redis操作**: 全削除による高速クリア
- **State操作**: インメモリ更新による即座反映
- **ネットワーク**: Discord API 1回呼び出し（Typing + Send）

## 実装効果
- **確実日報**: JST 06:00での確実な日報生成・投稿
- **システムリセット**: 日報後の確実な全文脈クリア
- **状態整合**: ACTIVE・command-center状態での新日開始
- **Fail-Fast**: エラー時の即座停止による整合性保証

## 次期実装との連携
- **Task 12-1（段階タグ）**: on_report_0600でのエラー時段階識別
- **Task 13-1（モード追従）**: ACTIVEモード設定との統合
- **Task 15-4（日報E2E）**: 実際のDiscord環境での受け入れ試験

## コミット情報
```
feat: 11-2 日報生成・リセットシステム実装（Spectra固定・500字・LLM1回・全文脈リセット）
```