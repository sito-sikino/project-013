# 実装ログ: ログ（logger.py／JSONL一元）
実行日時: 2025-08-13 10:22

## 完了タスク

### 2-1 JSONLロガー
**AC**: `log_ok(event_type,channel,actor,payload_summary)` / `log_err(...,error_stage,error_detail)` を提供。
行スキーマ固定：`ts,event_type,channel,actor,payload_summary,result,error_stage,error_detail` を `logs/run.log` に追記。ファイルが無ければ自動作成。

### 2-2 スナップショットテスト
**AC**: ok/err を各2行出力し、フォーマット一致。

## 実装の背景
Discord マルチエージェントシステムのログ基盤を、spec.mdとarchitecture.mdの仕様に基づいてJSONL形式で構築。
システム全体の動作とエラーを一元管理し、Fail-Fast原則に基づく監視・デバッグを可能にする。

## 設計意図
- **JSONL一元管理**: システム＋会話ログを1ファイルで集約
- **構造化ログ**: 固定スキーマによる解析・監視の容易性
- **Fail-Fast対応**: エラー段階の詳細記録で即座デバッグ
- **高性能**: orjsonによる高速JSON処理
- **スレッドセーフ**: 並行アクセスに対応した安全なログ書き込み
- **JST統一**: Asia/Tokyoタイムゾーンでの一貫したタイムスタンプ

## 実装詳細

### app/logger.py の構成
- **公開I/F**: `log_ok()`, `log_err()`
- **内部関数**: `_write_log_entry()`, `_get_jst_timestamp()`, `_ensure_log_directory()`
- **スキーマ**: 8つの必須キー（ts, event_type, channel, actor, payload_summary, result, error_stage, error_detail）
- **エラーハンドリング**: ログ出力失敗時でもアプリケーションを継続

### JSONLスキーマ仕様
```json
{
  "ts": "2025-08-13T10:21:28.327143+09:00",
  "event_type": "user_msg|slash|auto_tick|report",
  "channel": "command-center|creation|development|lounge",
  "actor": "user|spectra|lynq|paz|system", 
  "payload_summary": "先頭80字で切り詰め",
  "result": "ok|error",
  "error_stage": "settings|slash|plan|typing|send|report|memory|null",
  "error_detail": "例外要約 or null"
}
```

### エラーステージ定義
- **settings**: 設定欠落・無効値
- **slash**: Slash解析/状態更新失敗
- **plan**: LLM呼び出し（生成）失敗
- **typing**: Typing送信失敗
- **send**: 本文送信失敗
- **report**: 日報処理失敗
- **memory**: Redis 読込/追記/リセット失敗

### 技術実装
- **orjson**: 高速JSON serialization
- **threading.Lock**: スレッドセーフなファイル書き込み
- **zoneinfo**: Python標準のタイムゾーン処理（Asia/Tokyo）
- **pathlib**: モダンなパス操作
- **自動ディレクトリ作成**: logs/ディレクトリの自動生成
- **ペイロード切り詰め**: 80文字制限の自動処理

## スナップショットテスト詳細

### test_logger_snapshot.py の機能
- **OK/ERRログ**: 各2行の生成と検証
- **フォーマット検証**: 全必須キーの存在確認
- **構造検証**: OK/ERRログの適切なnull/非null設定
- **タイムスタンプ検証**: JST (+09:00) 形式の確認
- **JSONLパース**: 全エントリの有効なJSON形式確認

### テスト結果
```
📊 新規生成エントリ数: 4
✅ エントリ 1: Valid ok format
✅ エントリ 2: Valid ok format  
✅ エントリ 3: Valid error format
✅ エントリ 4: Valid error format

📋 スナップショット結果:
   ✅ OK エントリ: 2行（期待値: 2行）
   ✅ ERR エントリ: 2行（期待値: 2行）
   ✅ 全エントリがJSONL形式に準拠
   ✅ 全エントリが必須キースキーマに準拠
   ✅ タイムスタンプがJST（+09:00）形式
```

## 副作用 / 注意点
- logs/ディレクトリの自動作成（初回実行時）
- ログファイルの継続的な成長（ローテーション機能は未実装）
- orjsonの高速JSONシリアライゼーション（バイナリ依存）
- スレッドロックによる並行書き込み制御
- ログ出力エラー時はstderrに出力（サイレント失敗回避）

## 関連ファイル・関数
- `/home/u/dev/project-013/app/logger.py` - ログ管理モジュール
  - `log_ok()` - 成功ログ記録
  - `log_err()` - エラーログ記録
  - `_write_log_entry()` - 内部書き込み処理
  - `_get_jst_timestamp()` - JSTタイムスタンプ生成
  - `_ensure_log_directory()` - ディレクトリ自動作成
- `/home/u/dev/project-013/test_logger_snapshot.py` - スナップショットテスト
- `/home/u/dev/project-013/logs/run.log` - JSONL形式のログファイル

## 次のステップ
Phase 3 IMPLEMENT の次タスク「3. ストア（store.py／Redis全文脈）」の実装に進む。
Redisによる当日全文脈の保存・読み込み・リセット機能の構築を行う。