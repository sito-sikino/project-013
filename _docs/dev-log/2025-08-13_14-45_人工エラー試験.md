# Task 12-2: 人工エラー試験システム実装

## 完了タスク
**12-2 人工エラー試験**  
**AC**: 各ステージで意図的に例外を起こし、正しい `error_stage` がログに残る。

## 実装の背景
Task 12-1で実装したエラー段階タグシステムの動作を検証するため、意図的にエラーを発生させて各段階でのエラー処理とログ記録が適切に行われることを確認する包括的テストスイートが必要だった。Fail-Fast原則に基づく動作確認と、7段階すべてのエラー処理パスの検証が目的。

## 設計意図

### 人工エラー発生手法
各エラー段階で意図的に例外を起こし、実際のシステム動作を模倣：
- **Settings段階**: `settings.fail_fast()`直接呼び出し
- **Slash段階**: 無効パラメータでのバリデーションエラー、状態更新エラー
- **Plan段階**: LLM生成失敗（supervisor.generate）
- **Typing段階**: Discord typing API失敗
- **Send段階**: Discord send API失敗  
- **Report段階**: 日報生成失敗、store.reset()失敗
- **Memory段階**: Redis読み取り/書き込み失敗、接続エラー

### 検証項目
1. **error_stage正確性**: 各段階で正しいerror_stageがlog_errに記録される
2. **SystemExit動作**: Fail-Fast原則によりすべてのエラーでSystemExit発生
3. **エラーメッセージ保持**: 元の例外メッセージがerror_detailに保存される
4. **段階完全性**: 7段階すべてに対応するテストが存在する

### テスト構造の改善（DRY原則）
- **共通環境変数管理**: `_TEST_ENV_VARS`辞書で一元管理
- **共通検証ヘルパー**: `verify_error_stage_logging()`でログ検証を統一  
- **エラー発生ヘルパー**: `trigger_common_sequence_error()`で基本パターンを抽象化
- **型ヒント**: `Dict`, `List`, `inspect`モジュール活用で品質向上

## 副作用・注意点

### テスト実行環境
- 全テストでSystemExitが発生するため`pytest.raises(SystemExit)`必須
- MockとPatchの順序が重要（前段階のモックが後段階エラーを隠蔽しないよう）
- 各段階のエラーパスが確実に実行されるよう前段階の成功を保証

### パフォーマンス考慮
- 13個のテストで comprehensive coverage を提供
- 各テストは独立して実行可能
- async/awaitパターンで非同期処理を適切にテスト

### メンテナンス性
- テストクラス名とエラー段階の対応が明確
- テストメソッド命名規則で機能識別が容易
- 完全性テストで実装漏れを自動検出

## 関連ファイル・関数

### 新規作成
- **test_artificial_error_testing.py**: 人工エラー試験の包括テストスイート
  - 13個のテストケース（各段階＋完全性検証）
  - 共通ヘルパー関数でDRY原則適用
  - 型ヒントとdocstringで品質向上

### テスト対象
- **app/settings.py**: `fail_fast()`での設定エラー処理
- **app/app.py**: 
  - `execute_slash_command()`: スラッシュ段階エラー処理
  - `common_sequence()`: 複数段階エラー処理（plan, typing, send, memory）
  - `on_report_0600()`: 日報段階エラー処理
- **app/store.py**: `test_connection()`でのメモリ段階エラー処理

### テストカバレッジ
1. **TestArtificialErrorSettings**: 設定段階（1テスト）
2. **TestArtificialErrorSlash**: スラッシュ段階（2テスト）
3. **TestArtificialErrorPlan**: 計画段階（1テスト）
4. **TestArtificialErrorTyping**: タイピング段階（1テスト）
5. **TestArtificialErrorSend**: 送信段階（1テスト）
6. **TestArtificialErrorReport**: 日報段階（2テスト）
7. **TestArtificialErrorMemory**: メモリ段階（3テスト）
8. **TestArtificialErrorCompleteness**: 完全性検証（2テスト）

## TDDサイクル完了
✅ Red: 13個の人工エラーテストで各段階の動作要件を明確化  
✅ Green: 全テスト通過（Task 12-1の段階タグシステムが正常動作）  
✅ Refactor: DRY原則、共通ヘルパー、型ヒント、構造化改善  
✅ Commit: 意味単位での保存完了

## 検証結果
- **全7段階**: settings, slash, plan, typing, send, report, memory すべてでエラー段階タグが正確に記録される
- **Fail-Fast動作**: すべてのエラーでSystemExitが発生し、フォールバック処理なし
- **エラー詳細保持**: 人工的に発生させたエラーメッセージがerror_detailに正確に記録される
- **システム堅牢性**: エラー処理パスが確実に動作し、ログ記録が完全に行われる