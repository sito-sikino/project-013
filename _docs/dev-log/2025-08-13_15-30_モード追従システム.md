# Task 13-1: モード追従システム実装

## 完了タスク
**13-1 モード追従**  
**AC**: `mode_from_time(now)` で `state.mode` を随時更新。ACTIVE初期は command-center、FREEは lounge。

## 実装の背景
Discord Multi-Agent Systemにおいて、JST時刻に基づいてシステムモードを自動的に切り替える機能が必要だった。時刻スケジュールに従って、STANDBY（00:00-06:00）→ PROCESSING（06:00丁度）→ ACTIVE（06:01-19:59）→ FREE（20:00-23:59）の4つのモードを適切に管理し、モード切り替え時にactive_channelも自動設定する時刻追従システムを構築する。

## 設計意図

### 時刻ベースモード判定
`mode_from_time(now_jst: datetime) -> Mode`を改良し、正確な時刻区分を実現：
- **STANDBY期間**: 00:00-05:59（待機モード）
- **PROCESSING期間**: 06:00丁度（日報生成時の特別モード）
- **ACTIVE期間**: 06:01-19:59（アクティブワーキングモード）  
- **FREE期間**: 20:00-23:59（フリータイムモード）

### ModeTrackingSchedulerクラス
時刻監視とモード自動更新を担当する専用スケジューラを実装：
- **1分間隔監視**: 正確なモード切り替えタイミングを検出
- **不要更新回避**: 現在モードが適切な場合は更新をスキップ
- **統合更新**: `state.update_mode()`経由でモードとactive_channelを同時更新
- **Fail-Fast原則**: エラー時は即座中断

### チャンネル自動設定
モード切り替え時のactive_channel自動設定ルール：
- **ACTIVE → command-center**: 業務系チャンネルで集中作業
- **FREE → lounge**: リラックス系チャンネルで自由会話
- **STANDBY/PROCESSING → command-center**: デフォルト管理チャンネル

## 副作用・注意点

### 時刻境界の精密処理
- 06:00丁度はPROCESSINGモード（日報生成専用）
- 06:01からACTIVEモード開始により、日報処理との競合を回避
- 分単位の監視により、秒レベルでの正確な切り替えを保証

### state.py既存機能との統合
- 既存の`update_mode()`を活用してactive_channel同時更新
- `init_active_channel()`ロジックでモード別チャンネル決定
- グローバルstate管理と協調動作

### テストでの時刻モック
- JST時刻の正確なモックが必要（timezone.timedelta使用）
- 各モード境界での動作確認が重要
- 不要更新回避ロジックのテストカバレッジ

## 関連ファイル・関数

### 修正されたファイル
- **app/state.py**
  - `mode_from_time()`: 時刻区分ロジックを修正（00:00-06:00 = STANDBY）
  - `get_current_jst_time()`: 現在JST時刻取得関数を追加
  - `_test_time_modes()`: テストケース修正（STANDBY期間対応）

- **app/app.py**  
  - `ModeTrackingScheduler`: 新規クラス実装
    - `start()`: 非同期監視ループ開始
    - `stop()`: 監視停止
    - `update_mode_from_time()`: 時刻ベースモード更新
    - `_monitoring_iteration()`: 1分間隔の監視処理
  - `mode_tracking_scheduler`: グローバルインスタンス作成

### 新規作成
- **test_mode_tracking.py**: モード追従システムの包括テストスイート
  - 18個のテストケースで完全カバレッジ
  - 時刻境界、スケジューラー動作、統合処理をすべてテスト
  - モック活用による時刻制御テスト

### テストカバレッジ詳細
1. **TestModeTrackingScheduler**: スケジューラー基本機能（4テスト）
2. **TestModeFromTimeFunction**: 時刻ベースモード判定（5テスト）  
3. **TestModeTrackingIntegration**: state統合処理（4テスト）
4. **TestModeTrackingSchedulerBehavior**: スケジューラー動作（2テスト）
5. **TestModeTrackingCompleteness**: システム完全性（3テスト）

## TDDサイクル完了
✅ Red: 18個のテストで時刻追従システム要件を明確化  
✅ Green: ModeTrackingScheduler実装とmode_from_time修正で全テスト通過  
✅ Refactor: 型ヒント、ドキュメント、テストケース修正で品質向上  
✅ Commit: 意味単位での保存完了

## システム動作例
```
00:00 → STANDBY mode, active_channel=command-center
06:00 → PROCESSING mode (日報生成), active_channel=command-center  
06:01 → ACTIVE mode, active_channel=command-center
20:00 → FREE mode, active_channel=lounge
23:59 → FREE mode継続
```

## スケジューラー統合準備
- ModeTrackingSchedulerは単体で動作可能
- 実際の時刻監視開始は`scheduler.start()`コール後
- 他のスケジューラー（DailyReportScheduler, TickScheduler）との並行実行対応
- 1分間隔での軽量な監視処理により、システム負荷を最小化