# 2025-08-13_16-00 自発発言スケジューラ実装

## 完了タスク
- [x] 10-1 スケジューラ  
**AC**: dev=15s/100%（**最大5分**で停止）、prod=300s/33%。外れtickは何もしない。

## 実装の背景
Discord Multi-Agent Systemにおける自発発言機能のスケジューリングシステムの実装。
ユーザーからの入力がない場合でも、システムが自発的にactive_channelに発言を行うためのタイマー・確率制御機能。

## 設計意図
- **環境別制御**: dev（15s/100%/5分制限）・prod（300s/33%/無制限）の完全分離
- **確率制御**: "外れtick"では何もしない（処理負荷軽減）
- **EventQueue統合**: 既存優先度システム（Slash→User→Tick）との完全統合
- **Fail-Fast原則**: 設定エラー時は起動時に即座停止
- **最小依存**: 既存アーキテクチャを最大活用、新規依存なし

## 実装詳細

### TDDサイクル実施
1. **Red**: test_scheduler.py作成（52テスト）
   - 基本機能・環境設定・タイマー精度・確率制御・EventQueue統合・エラーハンドリング・ライフサイクル

2. **Green**: app.pyにTickSchedulerクラス実装
   - 環境別設定取得メソッド（get_tick_interval/get_tick_probability/get_max_runtime）
   - 確率判定（should_execute_tick）
   - EventQueue統合（_enqueue_tick_event）
   - asyncioタイマーループ（start/_run_loop/stop）

3. **Refactor**: 品質改善
   - 型ヒント改善（Optional[int]）
   - 既存パターンとの一貫性確認

## 環境別仕様

### dev環境（開発・テスト用）
- **間隔**: 15秒
- **確率**: 100%（全tickで実行）
- **制限**: 最大5分で自動停止
- **用途**: 動作確認・テスト実行

### prod環境（本番運用）
- **間隔**: 300秒（5分）
- **確率**: 33%（約3回に1回実行）
- **制限**: なし（無期限実行）
- **用途**: 実際の自発発言システム

## TickSchedulerクラス仕様

### 主要メソッド
```python
class TickScheduler:
    async def start() -> None:          # スケジューラ開始
    def stop() -> None:                 # スケジューラ停止
    def get_tick_interval() -> int:     # 環境別間隔取得
    def get_tick_probability() -> float: # 環境別確率取得
    def get_max_runtime() -> Optional[int]: # 最大実行時間取得
    def should_execute_tick() -> bool:  # 確率判定
    async def _enqueue_tick_event():    # EventQueue統合
```

### 設定値統合
- **完全settings.py依存**: ハードコード値ゼロ
- **環境自動検出**: ENV=dev|prod自動切り替え
- **Fail-Fast検証**: 起動時に全設定値バリデーション

## EventQueue統合アーキテクチャ

### 優先度システム活用
1. **SLASH（優先度1）**: スラッシュコマンド最優先
2. **USER（優先度2）**: ユーザーメッセージ中優先  
3. **TICK（優先度3）**: 自発発言最低優先

### 統合方法
- **_enqueue_tick_event()**: `event_queue.enqueue(EventPriority.TICK, on_tick)`
- **直列処理保証**: 既存EventQueueシステムで自動制御
- **処理中回避**: 高優先度処理中はtickを後回し

## 確率制御メカニズム

### 確率判定ロジック
```python
def should_execute_tick(self) -> bool:
    """確率判定でtick実行可否を決定"""
    import random
    probability = self.get_tick_probability()
    return random.random() < probability
```

### "外れtick"の処理
- **dev環境**: 100%確率のため外れなし
- **prod環境**: 67%の確率で外れ、その場合は何もしない
- **処理負荷**: 確率外れ時はEventQueue追加なし

## タイマー精度とライフサイクル

### タイマー実装
- **asyncio.sleep()**: Python標準の高精度タイマー使用
- **while self.is_running**: 停止シグナル監視
- **時間制限**: dev環境での自動停止機能

### ライフサイクル管理
- **初期状態**: is_running=False
- **重複開始防止**: 既に実行中の場合はRuntimeError
- **清潔な停止**: finallyブロックでis_running=False保証

## エラーハンドリング

### Fail-Fast実装
- **設定値検証**: 初期化時に確率値（0.0-1.0）バリデーション
- **設定値欠落**: settings.py値欠落時は即座に例外
- **EventQueue例外**: enqueue失敗時は例外伝播

### エラー種別
- **ValueError**: 無効な確率値（<0.0 or >1.0）
- **RuntimeError**: 重複スケジューラ開始
- **AttributeError**: settings設定値欠落

## 副作用 / 注意点
- **dev環境制限**: 5分後自動停止（テスト用安全装置）
- **確率変動**: prod環境では実行タイミングが不定期
- **EventQueue依存**: 既存EventQueueシステムに完全依存
- **関数内インポート**: 循環インポート回避のためapp importは関数内
- **グローバルインスタンス**: tick_scheduler = TickScheduler()で単一インスタンス

## 関連ファイル・関数
- `/home/u/dev/project-013/app/app.py`
  - `TickScheduler`: 自発発言スケジューラクラス
  - `tick_scheduler`: グローバルインスタンス
  - `EventQueue`: 優先度制御システム（既存活用）
  - `on_tick()`: tickハンドラ関数（10-2で実装予定）
- `/home/u/dev/project-013/app/settings.py`
  - tick設定値（間隔・確率・最大時間）
- `/home/u/dev/project-013/test_scheduler.py`
  - 全52テストケース（基本・環境・タイマー・確率・統合・エラー・ライフサイクル）

## 設定値一覧
- **TICK_INTERVAL_SEC_DEV**: 15（秒）
- **TICK_PROB_DEV**: 1.0（100%）
- **MAX_TEST_MINUTES**: 5（分）
- **TICK_INTERVAL_SEC_PROD**: 300（秒）
- **TICK_PROB_PROD**: 0.33（33%）

## 次期実装との連携
- **10-2（投稿）**: on_tick()関数の本格実装でactive_channelに自発発言
- **10-3（優先度）**: 既存EventQueueシステムで優先度制御は実装済み

## テストカバレッジ
- **基本機能**: クラス存在・インスタンス・メソッド確認
- **環境設定**: dev/prod設定値・動的切り替え
- **タイマー精度**: 間隔正確性・最大実行時間・無期限実行
- **確率制御**: dev=100%・prod=33%・確率スキップ
- **EventQueue統合**: TICK優先度・enqueue・統合確認
- **エラーハンドリング**: 設定エラー・EventQueueエラー・無効設定
- **ライフサイクル**: 初期状態・開始停止・重複開始防止

## パフォーマンス特性
- **メモリ使用量**: 最小（単純なasyncioタスク）
- **CPU使用量**: 間欠的（タイマー間隔でのみ処理）
- **ネットワーク影響**: なし（ローカル処理のみ）
- **Redis影響**: なし（確率判定のみ、実際の処理は10-2）

## コミット情報
```
feat: 10-1 自発発言スケジューラ実装（環境別間隔・確率制御・EventQueue統合）
```