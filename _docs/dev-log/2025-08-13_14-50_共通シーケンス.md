# 2025-08-13_14-50 共通シーケンス実装

## 完了タスク
- [x] 7-2 共通シーケンス  
**AC**: **Redis全文読み→LLM→Typing→Send→Redis追記→log_ok**。どこかで失敗→ **log_err** ＆中断（Fail-Fast）。

## 実装の背景
Discord Multi-Agent Systemにおける中核処理フローの実装。
すべてのイベント（slash, user_msg, auto_tick, report）が共通して実行する6段階の処理シーケンスを一元化。

## 設計意図
- **6段階フロー**: Redis読み→LLM生成→Typing送信→メッセージ送信→Redis追記→ログ記録の順次処理
- **Fail-Fast原則**: 各段階でエラー発生時は適切なerror_stageでログ記録後、即座にSystemExitで停止
- **エラー段階分類**: memory(Redis), plan(LLM), typing, send(Discord)として段階別にエラーを分類
- **テスト互換性**: Record型とdict型の両方に対応し、本番とテストの両環境で動作

## 実装詳細

### TDDサイクル実施
1. **Red**: test_common_sequence.py作成（18テスト）
   - 関数存在確認
   - 6段階フロー実行確認
   - 各段階の個別テスト
   - エラーハンドリングテスト
   - Fail-Fast動作確認

2. **Green**: app.pyにcommon_sequence関数実装
   - 6段階の順次処理
   - Record/dict自動判別処理
   - settings.settings.channel_limitsからの制限値取得
   - エラー段階推定ロジック

3. **Refactor**: 
   - 未使用変数削除（typing_status, message_id）
   - Black/Flake8準拠のフォーマット適用
   - テストのペイロード長調整（12文字）

## 副作用 / 注意点
- **settings参照パス**: settings.settings.channel_limitsという二重参照が必要
- **チャンネル引数の混在**: channel（論理名）とllm_channel（Discord ID）の使い分けに注意
- **store.append引数**: Redisへの追記は物理的なllm_channel IDを使用（論理名channelではない）
- **エラー段階推定**: エラーメッセージ文字列から段階を推定するため、完全な精度は保証されない

## 関連ファイル・関数
- `/home/u/dev/project-013/app/app.py`
  - `common_sequence()`: 6段階共通シーケンス実装
- `/home/u/dev/project-013/test_common_sequence.py`
  - 全18テストケース（関数定義、実行フロー、エラーハンドリング）
- 依存モジュール:
  - `app.store`: Redis全文脈操作
  - `app.supervisor`: LLM生成処理
  - `app.discord`: Typing/Send API
  - `app.logger`: JSONL形式ログ出力
  - `app.settings`: 設定値取得
  - `app.state`: システムステート管理

## コミット情報
```
feat: 7-2 共通シーケンス実装（Redis→LLM→Typing→Send→Redis→log_ok）
```