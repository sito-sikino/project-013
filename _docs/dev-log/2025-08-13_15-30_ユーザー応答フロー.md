# 2025-08-13_15-30 ユーザー応答フロー実装

## 完了タスク
- [x] 9-1 応答フロー  
**AC**: 受信CHへ **選定Bot名義で Typing→Send**。LLMは1回、上限内（途中切断なし）。Redisに user発言+bot応答 を追記。

## 実装の背景
Discord Multi-Agent Systemにおけるユーザーメッセージへの即時応答機能の実装。
ユーザーが送信したメッセージに対して、適切なボット（Spectra/LynQ/Paz）が文脈に応じて自動選択され、即座にTyping表示→返信を行うシステム。

## 設計意図
- **即応答**: ユーザーメッセージ受信後即座にTyping表示（体感速度重視）
- **AI駆動ボット選択**: LLMが文脈に応じて最適なボットを自動選択
- **既存アーキテクチャ活用**: common_sequenceの6段階フロー完全再利用
- **チャンネル制限遵守**: settings.pyの文字数制限を生成時に遵守（切断なし）
- **完全な文脈保存**: ユーザー発言とボット応答の両方をRedisに記録
- **Fail-Fast原則**: 各段階でのエラーは即座にlog_err→SystemExit

## 実装詳細

### TDDサイクル実施
1. **Red**: test_user_response_flow.py作成（41テスト）
   - 基本機能・チャンネルマッピング・ユーザーメッセージストレージ・共通シーケンス統合・Fail-Fast・統合テスト

2. **Green**: app.pyに2つの機能実装
   - `get_channel_name_from_id()`: Discord ID→論理チャンネル名マッピング
   - `on_user()`: 完全なユーザー応答フロー実装

3. **Refactor**: 品質確認
   - 既存パターンとの一貫性確認
   - 関数内インポートパターン維持（循環インポート回避）

## 処理フロー

### チャンネルマッピング
- **Discord ID→論理名**: settings.pyから動的取得
- **対応チャンネル**: command-center/creation/development/lounge
- **未知チャンネル**: "unknown"フォールバック

### ユーザー応答フロー
1. **Fail-Fast検証**: channel/text/user_idの必須パラメータ検証（既存）
2. **チャンネルマッピング**: get_channel_name_from_id()でDiscord ID→論理名
3. **ユーザー発言記録**: store.append("user", channel_name, text)
4. **共通シーケンス実行**: 6段階フロー
   - Redis全文読み→LLM生成→Typing→Send→Redis追記→log_ok
   - ボット自動選択（LLMが文脈で判断）
   - チャンネル制限内生成
   - payload_summary 80文字切り詰め

## ボット選択戦略
- **AI駆動**: LLMが会話文脈・チャンネル特性を考慮して最適ボット選択
- **3ボット対応**: Spectra（汎用）/LynQ（開発系）/Paz（創作系）
- **自動切替**: 会話の流れに応じてボットが自然に交代
- **検証**: supervisor.generate()がspeaker検証（必ず3ボットのいずれか）

## 体感速度最適化
- **即時Typing**: ユーザーメッセージ受信→即座にcommon_sequence呼び出し
- **Stage 3**: common_sequence内でTyping表示（discord.typing()）
- **イベントハンドラ内**: on_user関数内で同期的にTyping実行
- **待機時間最小**: Redis読み込み→LLM生成のレイテンシのみ

## エラーハンドリング
- **既存バリデーション**: channel/text/user_id空チェック（ValueError）
- **チャンネルマッピング**: 未知IDは"unknown"（例外なし）
- **Redis エラー**: store.append失敗時は例外伝播
- **LLM エラー**: common_sequence内でlog_err→SystemExit
- **Discord エラー**: common_sequence内でlog_err→SystemExit

## 副作用 / 注意点
- **文脈蓄積**: 全ユーザー発言とボット応答がRedis蓄積（日報まで保持）
- **ボット選択変動**: 同一ユーザーでも文脈次第でボット変更
- **チャンネル制限**: 長文ユーザー入力でも制限内応答（LLMが要約・調整）
- **関数内インポート**: 循環インポート回避のためapp importは関数内
- **payload切り詰め**: 80文字超過時は後半切り捨て

## 関連ファイル・関数
- `/home/u/dev/project-013/app/app.py`
  - `get_channel_name_from_id()`: チャンネルIDマッピング実装
  - `on_user()`: ユーザー応答フロー完全実装
  - `common_sequence()`: 6段階フロー（再利用）
- `/home/u/dev/project-013/app/settings.py`
  - Discord チャンネルID設定・文字数制限設定
- `/home/u/dev/project-013/test_user_response_flow.py`
  - 全41テストケース（基本・マッピング・ストレージ・統合・Fail-Fast）

## チャンネル制限対応
- **command-center**: 100文字制限
- **creation**: 200文字制限  
- **development**: 200文字制限
- **lounge**: 30文字制限
- **生成時遵守**: LLMプロンプトで制限指定→切断なし生成

## テストカバレッジ
- **基本機能**: 関数存在・シグネチャ・async確認
- **チャンネルマッピング**: 全4チャンネル + 未知チャンネル
- **メッセージストレージ**: Redis追記・チャンネル別・実行順序
- **共通シーケンス統合**: パラメータ検証・長文切り詰め・実行順序
- **Fail-Fast**: store/common_sequenceエラー伝播
- **統合**: 完全フロー・Typing即時性・既存バリデーション継続

## コミット情報
```
feat: 9-1 ユーザー応答フロー実装（即時Typing→AI選択Bot応答→Redis記録）
```