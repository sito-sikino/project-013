# 2025-08-13_16-15 自発投稿機能実装

## 完了タスク
- [x] 10-2 投稿  
**AC**: `active_channel` に **選定Bot名義**で Typing→Send。LLM1回・Redis追記・log_ok。

## 実装の背景
Discord Multi-Agent Systemにおける自発発言投稿機能の実装。
10-1で実装されたTickSchedulerから呼び出される`on_tick()`関数の本格実装により、システムがactive_channelに自発的に発言を行う機能。

## 設計意図
- **既存アーキテクチャ活用**: common_sequenceの6段階フロー完全再利用
- **最小実装**: 新規実装を最小化、既存機能との統合最大化
- **状態連携**: state.pyのactive_channelと完全連携
- **チャンネル制限遵守**: settings.pyの制限内で自動生成
- **Fail-Fast原則**: エラー時は既存パターンと同様に即座停止

## 実装詳細

### TDDサイクル実施
1. **Red**: test_tick_posting.py作成（44テスト）
   - on_tick実装・アクティブチャンネル統合・共通シーケンス統合・チャンネルIDマッピング・ボット選択・TickScheduler統合・エラーハンドリング・LLM種別・E2E一貫性

2. **Green**: 最小実装
   - `get_channel_id_from_name()`: 論理チャンネル名→Discord IDマッピング関数追加
   - `on_tick()`: TODOスタブを完全実装（common_sequence活用）

3. **Refactor**: 品質確認
   - 既存パターンとの一貫性確認（関数内インポート・コメント・変数命名）
   - コード構造の統一性確認

## 主要実装内容

### get_channel_id_from_name関数
```python
def get_channel_id_from_name(channel_name: str) -> str:
    """論理チャンネル名をDiscord IDにマッピング"""
    from app import settings
    
    channel_mapping = {
        "command-center": settings.settings.discord.chan_command_center,
        "creation": settings.settings.discord.chan_creation,
        "development": settings.settings.discord.chan_development,
        "lounge": settings.settings.discord.chan_lounge
    }
    return channel_mapping.get(channel_name, settings.settings.discord.chan_command_center)
```

**特徴**:
- **双方向マッピング**: 既存の`get_channel_name_from_id()`の逆変換
- **設定値依存**: settings.pyから動的取得、ハードコードなし
- **フォールバック**: 未知チャンネルはcommand-centerデフォルト

### on_tick関数完全実装
```python
async def on_tick() -> None:
    """自発発言処理ハンドラ（低優先度）"""
    from app import state
    
    # active_channelに自発発言投稿（10-2: 選定Bot名義・Typing→Send・LLM1回・Redis追記・log_ok）
    active_channel = state.get_active_channel()
    channel_id = get_channel_id_from_name(active_channel)
    payload_summary = f"auto_tick:{active_channel}"
    
    await common_sequence(
        event_type="auto_tick",
        channel=active_channel,
        actor="system",
        payload_summary=payload_summary,
        llm_kind="auto",
        llm_channel=channel_id
    )
```

**実装フロー**:
1. **状態取得**: `state.get_active_channel()`で現在のアクティブチャンネル取得
2. **ID変換**: `get_channel_id_from_name()`で論理名→Discord ID変換
3. **ペイロード作成**: `auto_tick:チャンネル名` 形式で要約作成
4. **共通シーケンス**: 既存6段階フロー活用で完全実装

## Common Sequence統合アーキテクチャ

### 6段階フロー活用
**既存common_sequence**が提供する完全機能:
1. **Redis全文読み**: 現在の文脈取得
2. **LLM生成**: kind="auto"で自発内容生成 + ボット選択
3. **Typing表示**: 選定Bot名義で入力中表示
4. **Send送信**: Discord投稿実行
5. **Redis追記**: 発言内容をRedisに記録
6. **log_ok**: 成功ログ記録

### パラメータ設計
- **event_type**: "auto_tick"（自発発言識別）
- **channel**: active_channel（状態管理連携）
- **actor**: "system"（システム発言明示）
- **payload_summary**: "auto_tick:チャンネル名"（内容要約）
- **llm_kind**: "auto"（自発モード指定）
- **llm_channel**: Discord ID（実際の投稿先）

## 状態管理システム統合

### Active Channel連携
- **取得**: `state.get_active_channel()`でリアルタイム状態取得
- **モード連携**: ACTIVE→command-center, FREE→lounge自動切替に対応
- **動的制御**: スラッシュコマンドでのactive_channel変更に即座対応

### チャンネル特性対応
- **command-center**: 100字制限・管理系発言
- **creation**: 200字制限・創作系発言
- **development**: 200字制限・開発系発言  
- **lounge**: 30字制限・雑談系発言

## LLM自発生成戦略

### LLM Kind "auto"活用
- **既存機能**: supervisor.py既対応のkind="auto"使用
- **ボット選択**: LLMが文脈・チャンネルに応じてSpectra/LynQ/Paz自動選択
- **内容生成**: 現在のtask文脈 + active_channel特性を考慮した自発発言
- **制限遵守**: 各チャンネルの文字数制限内で生成

### 文脈理解システム
- **Redis全文脈**: common_sequenceでRedis全履歴を文脈として使用
- **タスク連携**: state.task.contentの現在タスクを考慮
- **チャンネル適合**: 投稿先チャンネルの特性に応じた内容生成

## EventQueue統合完了

### TickScheduler→EventQueue→on_tick フロー
1. **TickScheduler**: 環境別間隔・確率で起動判定
2. **EventQueue**: TICK優先度で`on_tick()`をキュー追加
3. **優先度制御**: Slash/User処理中は自発発言を後回し
4. **on_tick実行**: active_channelに実際投稿

### 完全な直列処理
- **Fail-Fast**: 各段階でエラー時は即座停止
- **優先度遵守**: 高優先度イベントを妨げない設計
- **統一ログ**: 同一フォーマットでのlog_ok/log_errログ

## 副作用 / 注意点
- **文脈蓄積**: 自発発言もRedisに蓄積（他発言と同等扱い）
- **ボット選択変動**: チャンネル・文脈で選択ボットが変化
- **制限内生成**: 各チャンネル制限を超過しない自動調整
- **状態依存**: active_channelのリアルタイム変化に即座対応
- **確率的実行**: prod環境では33%確率のため不定期実行

## 関連ファイル・関数
- `/home/u/dev/project-013/app/app.py`
  - `on_tick()`: 自発投稿機能完全実装
  - `get_channel_id_from_name()`: チャンネルIDマッピング関数
  - `common_sequence()`: 6段階フロー（再利用）
  - `TickScheduler`: 10-1で実装済みスケジューラ
- `/home/u/dev/project-013/app/state.py`
  - `get_active_channel()`: アクティブチャンネル取得
- `/home/u/dev/project-013/test_tick_posting.py`
  - 全44テストケース（実装・統合・エラー・E2E）

## パフォーマンス特性
- **最小オーバーヘッド**: 新規処理はチャンネルマッピングのみ
- **既存機能活用**: Redis/LLM/Discord処理は既存実装利用
- **メモリ効率**: 新規状態管理なし、既存状態システム活用
- **ネットワーク効率**: 既存API呼び出しパターン踏襲

## テストカバレッジ
- **基本機能**: on_tick実装確認・非同期・パラメータなし
- **状態統合**: active_channel取得・異なるチャンネル対応
- **Common Sequence統合**: 呼び出し・正しいパラメータ・payload_summary形式
- **チャンネルマッピング**: 関数存在・全チャンネル・未知チャンネル・使用確認
- **ボット選択**: LLM kind auto使用
- **TickScheduler統合**: EventQueue経由呼び出し・優先度システム
- **エラーハンドリング**: state/common_sequenceエラー
- **LLM文脈**: auto kind・system actor・auto_tick event_type
- **E2E一貫性**: 完全フロー・パラメータ一貫性

## 次期実装との連携
- **10-3（優先度）**: 既存EventQueueで優先度制御実装済み
- **11-1, 11-2（日報）**: 同様のcommon_sequence活用パターンで実装可能

## 実装効果
- **完全自発発言**: dev環境15秒・prod環境5分間隔で自発投稿
- **文脈考慮発言**: Redis全履歴・現在タスクを考慮した自然な発言
- **チャンネル適合**: 各チャンネルの特性・制限に適合した内容
- **ボット多様性**: Spectra/LynQ/Pazが文脈に応じて自動選択

## コミット情報
```
feat: 10-2 自発投稿機能実装（active_channel→選定Bot→6段階common_sequence）
```